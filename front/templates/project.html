{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 혼잡도</title>
    <link rel="stylesheet" href="{% static 'project.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <header class="top-header">
      <div class="header-placeholder"></div>
      <h1 class="main-title">프론트</h1>
      <div id="clock" class="clock"></div>
  </header>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-location-dot"></i>
            </div>
            <nav class="menu">
                <ul>
                    <li><a href="#"><i class="fa-solid fa-users"></i><span>실시간 인구</span></a></li>
                    <li><a href="#"><i class="fa-solid fa-magnifying-glass"></i><span>장소검색</span></a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <div class="card">
                <h2>실시간 영상</h2>
                <img src="{% url 'live_stream_view' file_name='111.mp4' %}"
                    alt="Live Stream" 
                    style="width:100%; max-width:1270px; border-radius: 8px;">
            </div>
            <section class="info-panel">
                <div class="header">
                    <h2>현재 카페 이름</h2>
                    <span></span>
                </div>
                <div class="card population">
                    <h3>실시간 인구 현황</h3>
                    <div class="population-graph">
                        <img id="graph-image" src="" data-src="{% url 'congestion_graph' %}" alt="인구 현황 그래프 로딩 중...">
                    </div>
                    <div class="population-details" data-url="{% url 'congestion_status' %}">
                        <p id="population-count" class="count">측정중...</p>
                        <p id="congestion-steps" class="step">측정중...</p>
                    </div>
                </div>
            </section>
            <section class="imag-area">
                <div class="carousel">
                    <button class="btn prev" aria-label="이전">‹</button>
                    <div class="viewport">
                        <div class="track">
                            <img src="{% static 'cafe0.jpg' %}" alt="">
                            <img src="{% static 'cafe1.jpg' %}" alt="">
                            <img src="{% static 'cafe2.jpg' %}" alt="">
                        </div>
                    </div>
                    <button class="btn next" aria-label="다음">›</button>
                </div>
            </section>
        </main>
    </div>
    <script src="{% static 'script.js' %}"></script>
    <script>
        // 그래프를 업데이트하는 함수를 따로 만듭니다.
        function updateGraph() {
            const graphImage = document.getElementById('graph-image');
            if (graphImage) {
                // ✨ 핵심: 캐시(Cache) 방지를 위해 URL 뒤에 현재 시간을 덧붙입니다.
                // 이렇게 하면 브라우저는 매번 새로운 이미지라고 인식하여 서버에 다시 요청합니다.
                const url = graphImage.dataset.src;
                graphImage.src = url + '?t=' + new Date().getTime();
            }
        }

        // 페이지가 처음 로드될 때 한 번 즉시 실행
        updateGraph();

        // 그 후 5초(5000밀리초)마다 updateGraph 함수를 계속해서 실행
        setInterval(updateGraph, 5000);
    </script>
    <script>
        // 1. 필요한 HTML 요소들을 가져옵니다.
        const populationDiv = document.querySelector('.population-details');
        const countElement = document.getElementById('population-count');
        const CongestionElement = document.getElementById('congestion-steps');
        
        // 2. HTML에 저장해둔 API URL을 가져옵니다.
        const apiUrl = populationDiv.dataset.url;

        // 3. 혼잡도 데이터를 요청하고 화면을 업데이트하는 함수를 만듭니다.
        function updateCongestionStatus() {
            fetch(apiUrl) // API에 데이터 요청
                .then(response => response.json()) // 응답을 JSON 형태로 변환
                .then(data => {
                    // JSON 데이터에서 object_count 값을 사용해 화면의 텍스트를 변경
                    // 예: data = {"level": 3, "label": "혼잡", "object_count": 52}
                    countElement.textContent = `${data.object_count}명`;
                    CongestionElement.textContent = `${data.label}`;
                })
                .catch(error => {
                    // 에러가 발생하면 콘솔에 출력
                    console.error('데이터를 불러오는 데 실패했습니다:', error);
                    countElement.textContent = '오류';
                });
        }

        // 4. 페이지가 처음 로드될 때 한번 실행하고,
        updateCongestionStatus();
        
        // 5. 그 후 5초(5000ms)마다 주기적으로 함수를 반복 실행합니다. (시간은 조절 가능)
        setInterval(updateCongestionStatus, 5000); 
    </script>
</body>
</html>